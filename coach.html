<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø´Ø§Øª Ø§Ù„ÙƒÙˆØªØ´</title>

<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  body{
    font-family:"Tajawal", Arial, sans-serif;
    background:#050505;
    color:#fff;
  }

  .layout{
    display:flex;
    height:100vh;
  }

  /* ==== Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ==== */
  .clients-panel{
    width:260px;
    border-left:1px solid #222;
    background:#080808;
    display:flex;
    flex-direction:column;
  }
  .clients-header{
    padding:12px;
    border-bottom:1px solid #222;
    font-weight:600;
    font-size:15px;
  }
  .clients-list{
    flex:1;
    overflow-y:auto;
  }
  .client-item{
    padding:10px 12px;
    border-bottom:1px solid #111;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    transition:background .2s;
  }
  .client-item:hover,
  .client-item.active{
    background:#151515;
  }
  .client-avatar{
    width:36px;
    height:36px;
    border-radius:50%;
    overflow:hidden;
  }
  .client-avatar img{
    width:100%;height:100%;object-fit:cover;
  }
  .client-meta{
    display:flex;
    flex-direction:column;
    font-size:13px;
  }
  .client-name{
    font-weight:600;
  }
  .client-email{
    color:#aaa;
    font-size:11px;
  }

  /* ==== Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª ==== */
  .chat-panel{
    flex:1;
    display:flex;
    flex-direction:column;
    background:#0b0b0b;
  }

  /* HEADER */
  #chatHeader{
    padding:10px 14px;
    background:#080808;
    border-bottom:1px solid #1c1c1c;
    min-height:60px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  #chatHeader img{
    width:42px;height:42px;border-radius:50%;object-fit:cover;
    border:2px solid #a51414;
  }
  .header-info{
    display:flex;flex-direction:column;font-size:14px;
  }
  .header-name{font-weight:600;}
  .header-status{font-size:12px;color:#aaa;}

  /* MESSAGES */
  #chatMessages{
    flex:1;
    padding:12px;
    overflow-y:auto;
    background:#0b0b0b;
  }
  .bubble{
    padding:8px 12px;
    margin:8px 0;
    max-width:75%;
    border-radius:14px;
    position:relative;
    font-size:14px;
    line-height:1.6;
    word-wrap:break-word;
    cursor:pointer;
  }
  .me{
    background:#a51414;
    margin-left:auto;
    border-bottom-right-radius:3px;
  }
  .them{
    background:#242424;
    margin-right:auto;
    border-bottom-left-radius:3px;
  }
  .bubble img{
    max-width:220px;
    border-radius:10px;
    display:block;
  }

  .reply-box{
    font-size:11px;
    padding:4px 8px;
    border-right:3px solid #ffd66b;
    border-radius:10px;
    background:rgba(0,0,0,0.3);
    margin-bottom:4px;
  }
  .reply-from{color:#ffd66b;margin-bottom:2px;}
  .reply-text{
    color:#eee;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .time{
    font-size:10px;
    color:#ddd;
    margin-top:4px;
    text-align:left;
    opacity:0.75;
  }

  /* REPLY PREVIEW */
  #replyPreview{
    display:none;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    background:#101010;
    border-top:1px solid #1f1f1f;
    border-bottom:1px solid #1f1f1f;
  }
  #replyPreview-text{flex:1;font-size:12px;}
  #replyPreview-title{font-size:11px;color:#ffd66b;}
  #replyPreview-body{font-size:12px;color:#eee;}
  #replyPreview-close{
    border:none;background:transparent;color:#fff;
    cursor:pointer;font-size:18px;
  }

  /* INPUT */
  #chatInputBox{
    padding:8px;
    background:#080808;
    border-top:1px solid #1c1c1c;
    display:flex;
    gap:8px;
  }
  #msgInput{
    flex:1;
    padding:10px;
    border-radius:10px;
    border:none;
    font-size:14px;
  }
  #sendBtn,#imgBtn{
    padding:0 12px;
    border:none;
    border-radius:10px;
    background:#a51414;
    color:#fff;
    cursor:pointer;
    font-size:15px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #noClientHint{
    padding:20px;
    text-align:center;
    color:#bbb;
    font-size:14px;
  }

  /* Ù…ÙˆØ¨Ø§ÙŠÙ„: Ù†Ø®Ù„ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆÙ‚ ÙˆØ§Ù„Ø´Ø§Øª ØªØ­Øª */
  @media(max-width:768px){
    .layout{flex-direction:column;}
    .clients-panel{
      width:100%;
      height:160px;
    }
    .chat-panel{
      flex:1;
      height:calc(100vh - 160px);
    }
    .bubble{max-width:85%;}
  }

  .my-btn {
    display: inline-block;
    padding: 12px 20px;
    background: #9e9595;
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    font-size: 16px;
    font-family: Arial, sans-serif;
    transition: 0.3s;
}

.my-btn:hover {
    background: #a30e0e;
}
</style>
</head>
<body>
  <a href="coachWorkouts.html" class="my-btn">Ù„ÙˆØ­Ù‡ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†</a>

<div class="layout">

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
  <aside class="clients-panel">
    <div class="clients-header">ğŸ‘¥ Ø¹Ù…Ù„Ø§Ø¤Ùƒ</div>
    <div id="clientsList" class="clients-list">
      <!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù‡ÙŠØªØ­Ø·ÙˆØ§ Ù‡Ù†Ø§ -->
    </div>
  </aside>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª -->
  <section class="chat-panel">
    <div id="chatHeader">
      Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ‘ˆ
    </div>

    <div id="chatMessages">
      <div id="noClientHint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</div>
    </div>

    <div id="replyPreview">
      <div id="replyPreview-text">
        <div id="replyPreview-title"></div>
        <div id="replyPreview-body"></div>
      </div>
      <button id="replyPreview-close">âœ•</button>
    </div>

    <div id="chatInputBox" style="display:none;">
      <button id="imgBtn">ğŸ“·</button>
      <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„...">
      <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </section>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, setDoc,
  collection, query, where, onSnapshot, addDoc,
  orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYTF1Kuju-i06J__sQ0sNqEOD7CcQYeos",
  authDomain: "ahmed-mostafa-abfef.firebaseapp.com",
  projectId: "ahmed-mostafa-abfef",
  storageBucket: "ahmed-mostafa-abfef.firebasestorage.app",
  messagingSenderId: "542458359790",
  appId: "1:542458359790:web:2c3a8b06e5c7e89df528ff",
  measurementId: "G-18FBMGFYJJ"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// Ø§Ù„ÙƒØ¨Ø§ØªÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù…
const COACHES = [
  { uid:"8e4HYnBesygal9lahcWh4fVXBmy2", email:"am3951301@gmail.com" }
];

function isCoach(user){
  return COACHES.some(c => c.uid===user.uid || c.email===user.email);
}

// DOM
const clientsList       = document.getElementById("clientsList");
const chatHeader        = document.getElementById("chatHeader");
const chatMessages      = document.getElementById("chatMessages");
const chatInputBox      = document.getElementById("chatInputBox");
const msgInput          = document.getElementById("msgInput");
const sendBtn           = document.getElementById("sendBtn");
const imgBtn            = document.getElementById("imgBtn");
const replyPreview      = document.getElementById("replyPreview");
const replyPreviewTitle = document.getElementById("replyPreview-title");
const replyPreviewBody  = document.getElementById("replyPreview-body");
const replyPreviewClose = document.getElementById("replyPreview-close");

let COACH = null;
let CURRENT_CLIENT = null;
let CHAT_ID = null;
let messagesUnsub = null;
let replyData = null;

// Ø­Ø§Ù„Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
async function setOnline(uid,status){
  await setDoc(doc(db,"users",uid),{
    online:status,
    lastSeen: serverTimestamp()
  },{merge:true});
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¯
function clearReply(){
  replyData = null;
  replyPreview.style.display = "none";
  replyPreviewTitle.textContent = "";
  replyPreviewBody.textContent  = "";
}

// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø¯
function activateReply(messageData, isMe){
  const baseText = messageData.text || (messageData.image ? "ØµÙˆØ±Ø©" : "");
  const fromName = isMe ? "Ø£Ù†Øª" : (CURRENT_CLIENT?.fullName || "Ø§Ù„Ø¹Ù…ÙŠÙ„");

  replyData = { text: baseText, from: fromName };
  replyPreview.style.display  = "flex";
  replyPreviewTitle.textContent = `Ø±Ø¯ Ø¹Ù„Ù‰ ${fromName}`;
  replyPreviewBody.textContent  = baseText;
}
replyPreviewClose.addEventListener("click", clearReply);

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨ØªÙˆØ¹ Ø§Ù„ÙƒÙˆØªØ´
function loadCoachClients(coachEmail){
  const q = query(collection(db,"users"), where("coachEmail","==",coachEmail));

  onSnapshot(q, snap=>{
    clientsList.innerHTML = "";
    if(snap.empty){
      clientsList.innerHTML = `<div style="padding:12px;font-size:13px;color:#aaa;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§</div>`;
      return;
    }

    snap.forEach(docSnap=>{
      const data = docSnap.data();
      const li = document.createElement("div");
      li.className = "client-item";
      li.dataset.uid = docSnap.id;

      const avatarUrl = data.image || "https://i.imgur.com/3G0ZQZ9.png";

      li.innerHTML = `
        <div class="client-avatar"><img src="${avatarUrl}"></div>
        <div class="client-meta">
          <div class="client-name">${data.fullName || "Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</div>
          <div class="client-email">${data.email || ""}</div>
        </div>
      `;

      li.addEventListener("click", ()=>{
        document.querySelectorAll(".client-item").forEach(el=>el.classList.remove("active"));
        li.classList.add("active");
        openChatWithClient(docSnap.id, data);
      });

      clientsList.appendChild(li);
    });
  });
}

// ÙØªØ­ Ø´Ø§Øª Ù…Ø¹ Ø¹Ù…ÙŠÙ„
function openChatWithClient(clientUID, clientData){
  CURRENT_CLIENT = { id: clientUID, ...clientData };
  CHAT_ID = `${COACH.uid}_${clientUID}`;

  const img = clientData.image || "https://i.imgur.com/3G0ZQZ9.png";
  const statusText = clientData.online ? "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†" : "ØºÙŠØ± Ù…ØªØµÙ„";

  chatHeader.innerHTML = `
    <img src="${img}">
    <div class="header-info">
      <span class="header-name">${clientData.fullName || "Ø¹Ù…ÙŠÙ„"}</span>
      <span class="header-status">${statusText}</span>
    </div>
  `;

  chatInputBox.style.display = "flex";
  clearReply();

  if(messagesUnsub) messagesUnsub();
  loadMessages();
}

// ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø§Øª
function loadMessages(){
  chatMessages.innerHTML = "";
  const msgsRef = collection(db,"chats",CHAT_ID,"messages");
  const q = query(msgsRef, orderBy("time","asc"));

  let firstLoad = true;

  messagesUnsub = onSnapshot(q, snap=>{
    chatMessages.innerHTML = "";

    if(snap.empty){
      chatMessages.innerHTML = `<div id="noClientHint" style="padding:20px;text-align:center;color:#bbb;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</div>`;
      return;
    }

    snap.forEach(docSnap=>{
      const data = docSnap.data();
      const isMe = data.sender === COACH.uid;

      const div = document.createElement("div");
      div.className = "bubble " + (isMe ? "me" : "them");

      if(data.reply && data.reply.text){
        const rb = document.createElement("div");
        rb.className = "reply-box";
        const from = data.reply.from || "Ø±Ø¯";
        rb.innerHTML = `
          <div class="reply-from">${from}</div>
          <div class="reply-text">${data.reply.text}</div>
        `;
        div.appendChild(rb);
      }

      if(data.image){
        const img = document.createElement("img");
        img.src = data.image;
        div.appendChild(img);
      }else if(data.text){
        const t = document.createElement("div");
        t.textContent = data.text;
        div.appendChild(t);
      }

      if(data.time && data.time.toDate){
        const tm = document.createElement("div");
        tm.className = "time";
        tm.textContent = data.time.toDate().toLocaleTimeString([],{
          hour:"2-digit",minute:"2-digit"
        });
        div.appendChild(tm);
      }

      div.addEventListener("click", ()=> activateReply(data, isMe));

      chatMessages.appendChild(div);
    });

    chatMessages.scrollTop = chatMessages.scrollHeight;

    if(!firstLoad && snap.size>0){
      const lastMsg = snap.docs[snap.docs.length-1].data();
      if(lastMsg.sender !== COACH.uid && navigator.vibrate){
        navigator.vibrate(60);
      }
    }
    firstLoad = false;
  });
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
async function sendTextMessage(){
  if(!CHAT_ID || !CURRENT_CLIENT) return;
  const txt = msgInput.value.trim();
  if(!txt) return;

  await addDoc(collection(db,"chats",CHAT_ID,"messages"),{
    sender: COACH.uid,
    text: txt,
    image: null,
    time: serverTimestamp(),
    reply: replyData ? { text: replyData.text, from: replyData.from } : null
  });

  msgInput.value = "";
  clearReply();
}
sendBtn.onclick = sendTextMessage;
msgInput.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendTextMessage();
  }
});

// Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©
imgBtn.onclick = ()=>{
  if(!CHAT_ID || !CURRENT_CLIENT) return;
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = uploadImage;
  input.click();
};

async function uploadImage(e){
  const file = e.target.files[0];
  if(!file || !CHAT_ID || !CURRENT_CLIENT) return;

  const form = new FormData();
  form.append("image", file);

  const res = await fetch("https://api.imgbb.com/1/upload?key=230966cc91f42a69e2f64be5097c8b5c",{
    method:"POST",
    body:form
  });
  const data = await res.json();
  const url = data.data.url;

  await addDoc(collection(db,"chats",CHAT_ID,"messages"),{
    sender: COACH.uid,
    text: null,
    image: url,
    time: serverTimestamp(),
    reply: replyData ? { text: replyData.text, from: replyData.from } : null
  });

  clearReply();
}

// Ù…ØªØ§Ø¨Ø¹Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async user=>{
  if(!user) return window.location.href = "login.html";
  if(!isCoach(user)){
    alert("Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„ÙŠØ³ ÙƒØ§Ø¨ØªÙ†");
    return window.location.href = "index.html";
  }

  COACH = { uid:user.uid, email:user.email };
  await setOnline(user.uid,true);
  window.addEventListener("beforeunload", ()=> setOnline(user.uid,false));

  loadCoachClients(user.email);
});
</script>

</body>
</html>
