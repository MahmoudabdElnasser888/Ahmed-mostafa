<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل الدخول</title>
<style>
body { font-family: Arial; background:#000000; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; }
#login { max-width:400px; width:100%; padding:20px; background:rgb(8, 8, 8); border-radius:12px; box-shadow:0 0 10px rgba(255, 0, 0, 0.829); text-align: center; }
input { width:95%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #ff0000; background: #ffffff;}
#login h3{
    color: #ffffff;
    display: flex;
    justify-content: center;
}

button { padding:10px 20px; margin-top:10px; border:none; border-radius:6px; background:#f0ebeb; color:rgb(0, 0, 0); cursor:pointer; width:100%;transition: all 0.3s; }
button:hover{
    color: #ffffff;
    background-color: #a51414;
    transform: scale(1.03);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Loader */
#loader {
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.7);
    justify-content:center;
    align-items:center;
    z-index:9999;
}
#loader img {
    width:80px;
    height:80px;
    animation: spin 1s linear infinite;
}


</style>
</head>
<body>

<div id="loader">
    <img src="تصميم_بدون_عنوان__10_-removebg-preview.png" alt="Loading...">
</div>

<div id="login">
<h3>تسجيل الدخول / إنشاء حساب</h3>
<input id="fullName" placeholder="الاسم الكامل">
<input id="phone" placeholder="رقم الهاتف">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<input type="file" id="imageInput">
<button onclick="signup()">إنشاء حساب</button>
<button onclick="login()">تسجيل دخول</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYTF1Kuju-i06J__sQ0sNqEOD7CcQYeos",
  authDomain: "ahmed-mostafa-abfef.firebaseapp.com",
  projectId: "ahmed-mostafa-abfef",
  storageBucket: "ahmed-mostafa-abfef.firebasestorage.app",
  messagingSenderId: "542458359790",
  appId: "1:542458359790:web:2c3a8b06e5c7e89df528ff",
  measurementId: "G-18FBMGFYJJ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// الكابتن
const COACHES = [
    { uid:"8e4HYnBesygal9lahcWh4fVXBmy2", email:"am3951301@gmail.com" }
];

function isCoach(user){
    return COACHES.some(c => c.uid===user.uid || c.email===user.email);
}

setPersistence(auth,browserLocalPersistence);

const fullNameInput = document.getElementById("fullName");
const phoneInput = document.getElementById("phone");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const imageInput = document.getElementById("imageInput");

window.signup = async function(){
    const fullName = fullNameInput.value.trim();
    const phone = phoneInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const file = imageInput.files[0];

    if(!fullName || !phone || !email || !password) return alert("ادخل كل البيانات المطلوبة");

    // منع إنشاء حساب كابتن من هنا
    if(COACHES.some(c=>c.email===email)) return alert("هذا الايميل مخصص للكابتن، استخدم تسجيل الدخول فقط");

    let imageUrl = null;
    if(file){
        const form = new FormData();
        form.append("image",file);
        const res = await fetch("https://api.imgbb.com/1/upload?key=230966cc91f42a69e2f64be5097c8b5c",{
            method:"POST",
            body:form
        });
        const data = await res.json();
        imageUrl = data.data.url;
    }

    createUserWithEmailAndPassword(auth,email,password)
        .then(async userCred=>{
            const user = userCred.user;
            await setDoc(doc(db,"users",user.uid),{
                fullName,
                phone,
                email,
                image:imageUrl,
                timer:null,
                timerActive:false,
                chatLock:false,
                coachEmail:null
            },{merge:true});
            alert("تم إنشاء الحساب بنجاح");
            window.location.href="profile.html";
        })
        .catch(err=>alert(err.message));
};

window.login = function(){
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if(!email || !password) return alert("ادخل الايميل وكلمة المرور");

    signInWithEmailAndPassword(auth,email,password)
        .then(async userCred=>{
            const user = userCred.user;
            // تأكد من وجود document
            const docRef = doc(db,"users",user.uid);
            const docSnap = await getDoc(docRef);
            if(!docSnap.exists()){
                await setDoc(docRef,{
                    fullName:"",
                    phone:"",
                    email,
                    image:null,
                    timer:null,
                    timerActive:false,
                    chatLock:false,
                    coachEmail:null
                },{merge:true});
            }

            if(isCoach(user)){
                window.location.href="coach.html";
            }else{
                window.location.href="index.html";
            }
        })
        .catch(err=>alert(err.message));
};

const loader = document.getElementById("loader");

window.signup = async function(){
    const fullName = fullNameInput.value.trim();
    const phone = phoneInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const file = imageInput.files[0];

    if(!fullName || !phone || !email || !password) return alert("ادخل كل البيانات المطلوبة");

    if(COACHES.some(c=>c.email===email)) return alert("هذا الايميل مخصص للكابتن، استخدم تسجيل الدخول فقط");

    loader.style.display = "flex"; // اظهار الـ loader

    let imageUrl = null;
    if(file){
        const form = new FormData();
        form.append("image",file);
        try{
            const res = await fetch("https://api.imgbb.com/1/upload?key=230966cc91f42a69e2f64be5097c8b5c",{
                method:"POST",
                body:form
            });
            const data = await res.json();
            imageUrl = data.data.url;
        } catch(err){
            loader.style.display = "none";
            return alert("حدث خطأ أثناء رفع الصورة");
        }
    }

    createUserWithEmailAndPassword(auth,email,password)
        .then(async userCred=>{
            const user = userCred.user;
            await setDoc(doc(db,"users",user.uid),{
                fullName,
                phone,
                email,
                image:imageUrl,
                timer:null,
                timerActive:false,
                chatLock:false,
                coachEmail:null
            },{merge:true});
            loader.style.display = "none"; // اخفاء الـ loader
            alert("تم إنشاء الحساب بنجاح");
            window.location.href="profile.html";
        })
        .catch(err=>{
            loader.style.display = "none";
            alert(err.message);
        });
};

window.login = function(){
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if(!email || !password) return alert("ادخل الايميل وكلمة المرور");

    loader.style.display = "flex"; // اظهار الـ loader

    signInWithEmailAndPassword(auth,email,password)
        .then(async userCred=>{
            const user = userCred.user;
            const docRef = doc(db,"users",user.uid);
            const docSnap = await getDoc(docRef);
            if(!docSnap.exists()){
                await setDoc(docRef,{
                    fullName:"",
                    phone:"",
                    email,
                    image:null,
                    timer:null,
                    timerActive:false,
                    chatLock:false,
                    coachEmail:null
                },{merge:true});
            }

            loader.style.display = "none"; // اخفاء الـ loader

            if(isCoach(user)){
                window.location.href="coach.html";
            }else{
                window.location.href="index.html";
            }
        })
        .catch(err=>{
            loader.style.display = "none";
            alert(err.message);
        });
};

</script>

</body>
</html>
